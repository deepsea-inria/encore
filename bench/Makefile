all: basic

PBENCH_PATH=../../pbench

include $(PBENCH_PATH)/Makefile_common

-include settings.sh

PACKAGE_PATH=../../

CACTUS_HOME=$(PACKAGE_PATH)/cactus-stack/include
CHUNKEDSEQ_HOME=$(PACKAGE_PATH)/chunkedseq/include
ENCORE_INCLUDE_HOME=$(PACKAGE_PATH)/encore/include
CMDLINE_HOME=$(PACKAGE_PATH)/cmdline/include
PBBS_INCLUDE_HOME=$(PACKAGE_PATH)/pbbs-include
PCTL_INCLUDE_HOME=$(PACKAGE_PATH)/pctl/include
PBBS_PCTL_INCLUDE_HOME=$(PACKAGE_PATH)/pbbs-pctl/include
PBBS_PCTL_TEST_INCLUDE_HOME=$(PACKAGE_PATH)/pbbs-pctl/test/include
PBBS_PCTL_BENCH_INCLUDE_HOME=$(PACKAGE_PATH)/pbbs-pctl/bench/include
PBBS_PCTL_BENCH_GENERATORS_INCLUDE_HOME=$(PACKAGE_PATH)/pbbs-pctl/bench/include/generators
QUICKCHECK_INCLUDE_HOME=$(PACKAGE_PATH)/quickcheck/quickcheck

HWLOC_FLAGS=`pkg-config --cflags hwloc`
HWLOC_LIBS=`pkg-config --libs hwloc`
HWLOC_DIRECTIVES=-DHAVE_HWLOC $(HWLOC_FLAGS) $(HWLOC_LIBS)

INCLUDE_FILES=$(wildcard $(CHUNKEDSEQ_HOME)/*.hpp) $(wildcard $(ENCORE_INCLUDE_HOME)/*.hpp) $(wildcard $(CMDLINE_HOME)/*.hpp) $(wildcard $(PBBS_INCLUDE_HOME)/*.hpp) $(wildcard $(PCTL_INCLUDE_HOME)/*.hpp) $(wildcard $(PBBS_PCTL_INLCUDE_HOME)/*.hpp) $(wildcard $(PBBS_PCTL_TEST_INCLUDE_HOME)/*.hpp) $(wildcard $(PBBS_PCTL_BENCH_INCLUDE_HOME)/*.hpp) $(wildcard $(PBBS_PCTL_BENCH_GENERATORS_INCLUDE_HOME)/*.hpp) $(wildcard $(QUICKCHECK_INCLUDE_HOME)/*.hpp) $(wildcard $(CACTUS_HOME)/*.hpp) $(wildcard *.hpp)

INCLUDE_DIRECTIVES= -I $(CHUNKEDSEQ_HOME) -I $(ENCORE_INCLUDE_HOME) -I $(CMDLINE_HOME) -I $(PBBS_INCLUDE_HOME) -I $(PCTL_INCLUDE_HOME) -I $(PBBS_PCTL_INCLUDE_HOME) -I $(PBBS_PCTL_TEST_INCLUDE_HOME) -I $(PBBS_PCTL_BENCH_INCLUDE_HOME) -I $(PBBS_PCTL_BENCH_GENERATORS_INCLUDE_HOME) -I $(QUICKCHECK_INCLUDE_HOME) -I $(CACTUS_HOME)

TCMALLOC= $(TCMALLOC_HOME) -ltcmalloc

CILK_PLUS= -DUSE_CILK_PLUS -DUSE_CILK_PLUS_RUNTIME -fcilkplus -lcilkrts -ldl -DENCORE_BENCHMARK $(CUSTOM_CILKRTS_SETTINGS)

COMMON_PREFIX= -w -DHAVE_GCC_TLS -fpermissive -pthread -O2 -march=native -DNDEBUG -std=gnu++1y $(HWLOC_DIRECTIVES) -DTARGET_LINUX -m64 -DTARGET_X86_64 -DMANUAL_CONTROL #-DTIME_MEASURE
LOGGING_PREFIX=-DENCORE_ENABLE_LOGGING
DEBUG_PREFIX= -fpermissive -pthread -O0 -std=gnu++11 -g $(LOGGING_PREFIX) -DTARGET_LINUX -DDEBUG_ENCORE_STACK -DENCORE_RANDOMIZE_SCHEDULE #-DENCORE_SEQUENCE_USE_PBBS_VERSIONS

%.encore: %.cpp $(INCLUDE_FILES)
	g++ -DENCORE_ENABLE_STATS $(COMMON_PREFIX) $(TCMALLOC) $(INCLUDE_DIRECTIVES) -o $@ $<

%.log: %.cpp $(INCLUDE_FILES)
	g++ -DENCORE_ENABLE_STATS $(COMMON_PREFIX) $(TCMALLOC) $(INCLUDE_DIRECTIVES) $(LOGGING_PREFIX) -o $@ $<

%.dbg: %.cpp $(INCLUDE_FILES)
	g++ -DENCORE_ENABLE_STATS $(DEBUG_PREFIX) $(INCLUDE_DIRECTIVES) -o $@ $<

%.cilk: %.cpp $(INCLUDE_FILES) $(PBBS_INCLUDE_HOME)
	g++ $(CILK_PLUS) $(COMMON_PREFIX) $(TCMALLOC) $(INCLUDE_DIRECTIVES) -o $@ $<

%.cilk_debug: %.cpp $(INCLUDE_FILES) $(PBBS_INCLUDE_HOME)
	g++ $(CILK_PLUS) $(DEBUG_PREFIX) $(TCMALLOC) $(INCLUDE_DIRECTIVES) -o $@ $<

%.cilk_elision: %.cpp $(INCLUDE_FILES) $(PBBS_INCLUDE_HOME)
	g++ $(COMMON_PREFIX) $(TCMALLOC) $(INCLUDE_DIRECTIVES) -o $@ $<

clean: pbench_clean
	rm -f *.encore *.cilk *.dbg *.log *.cilk_elision *.cilk_debug
